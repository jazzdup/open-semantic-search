version: '3'
services:

  apps:
    image: opensemanticsearch/open-semantic-search
    build:
      context: .
    depends_on:
      - rabbitmq
      - solr
      - tika
    volumes:
      - config_etl:/etc/opensemanticsearch
      - config_solr-php-ui:/etc/solr-php-ui
      # Django sqlite DB for settings and thesaurus
      - data_db:/var/opensemanticsearch/db
      # Ontologies uploaded to Django web app and thumbnails generated by ETL
      - data_media:/var/opensemanticsearch/media
      #aL. link to file upload dir that can serve files without apache config change
      - /var/lib/docker/volumes/open-semantic-search_data_media/_data:/var/www/html
      #aL. link to code so can edit front end python, etc.
      - code_apps:/usr/lib/python3/dist-packages/opensemanticetl
    environment:
      - SOLR_PHP_UI_SOLR_HOST=solr
      - OPEN_SEMANTIC_ETL_MQ_BROKER=amqp://rabbitmq
      - OPEN_SEMANTIC_ETL_SOLR=http://solr:8983/solr/
      - OPEN_SEMANTIC_ETL_TIKA_SERVER=http://tika:9998
    ports:
      - "8080:80"

  etl:
    image: opensemanticsearch/open-semantic-etl
    build:
      context: src/open-semantic-etl/
    depends_on:
      - apps
      - rabbitmq
      - solr
      - tika
      - spacy-services
      - neo4j
    environment:
      - OPEN_SEMANTIC_ETL_MQ_BROKER=amqp://rabbitmq
      - OPEN_SEMANTIC_ETL_METADATA_SERVER=http://apps/search-apps/annotate/rdf?uri=[uri]
      - OPEN_SEMANTIC_ETL_SOLR=http://solr:8983/solr/
      - OPEN_SEMANTIC_ETL_TIKA_SERVER=http://tika:9998
      - OPEN_SEMANTIC_ETL_SPACY_SERVER=http://spacy-services:8080
      - OMP_THREAD_LIMIT=1
    volumes:
      # read only (:ro), since workers don't need to change the config (is done only by admin or web ui in container apps)
      - config_etl:/etc/opensemanticsearch:ro
      # write access to persistant thumbnails dir
      - data_media:/var/opensemanticsearch/media
      # aL. adding code
      # - COPY ./src/opensemanticetl /usr/lib/python3/dist-packages/opensemanticetl
      - code_etl:/usr/lib/python3/dist-packages/opensemanticetl

  solr:
    image: opensemanticsearch/solr
    build:
      context: src/solr.deb/
    volumes:
      - data_solr:/var/solr
    # uncomment next two lines, if you want access the Solr API and admin UI on host IP
    ports:
      - "8983:8983"

  tika:
    image: opensemanticsearch/tika-server
    build:
      context: src/tika-server.deb/
    environment:
      - OMP_THREAD_LIMIT=1
    ports:
      - "9998:9998"

  spacy-services:
    image: opensemanticsearch/spacy-services
    build:
      context: src/spacy-services.deb/src/spacy-services/

  rabbitmq:
    image: rabbitmq

  # flower:
  #   image: mher/flower
  #   environment:
  #     - CELERY_BROKER_URL=amqp://rabbitmq
  #     - FLOWER_PORT=5555
  #   ports:
  #     - "5555:5555"    

  neo4j:
    image: neo4j:3.5.25
    volumes:
      - ./plugins:/var/lib/neo4j/plugins
      - ./data:/var/lib/neo4j/data
      - ./import:/var/lib/neo4j/import
      - ./conf:/var/lib/neo4j/conf
    ports:
      - "7474:7474"
      - "7473:7473"
      - "7687:7687"
    environment:
      - "NEO4J_ACCEPT_LICENSE_AGREEMENT=yes"
      # - "NEO4J_AUTH=neo4j/neo4j"
      - "NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*"
      - "NEO4J_apoc_import_file_enabled=true"
      - "NEO4J_apoc_export_file_enabled=true"
      # - NEO4J_apoc_import_file_use__neo4j__config=true
      #- NEO4JLABS_PLUGINS=["apoc", "n10s"]
      - NEO4JLABS_PLUGINS=["apoc", "graph-data-science"]


volumes:
  config_etl:
  config_solr-php-ui:
  data_db:
  data_media:
  data_solr:
  code_etl:
  code_apps:
